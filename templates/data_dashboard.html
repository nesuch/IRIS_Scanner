<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IRIS - Data Explorer</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* --- EXISTING STYLES --- */
        .logo-text { margin-top: 8px; font-family: 'Montserrat', sans-serif; font-size: 30px; font-weight: 700; background: linear-gradient(180deg, #2b58a6 0%, #0a2357 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; color: transparent; letter-spacing: 1.5px; line-height: 1; text-transform: uppercase; padding-left: 1.5px; }
        .filter-search-box { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; font-size: 13px; box-sizing: border-box; }
        .quick-filter-chips { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; }
        .chip-btn { background: #eef2f6; border: 1px solid #dce1e6; padding: 4px 10px; border-radius: 12px; font-size: 11px; cursor: pointer; color: #1a237e; transition: 0.2s; user-select: none; }
        .chip-btn:hover { background: #e3f2fd; border-color: #2196f3; }
        .chip-btn.active { background-color: #2b58a6; color: white; border-color: #0a2357; font-weight: bold; }
        .view-selector-container { padding: 12px 15px; border-bottom: 1px solid #eee; background: #f8f9fa; }
        .view-selector-label { font-size: 11px; font-weight: bold; text-transform: uppercase; color: #666; display: block; margin-bottom: 4px; }
        .view-selector-dropdown { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; background: white; }

        /* --- CRITICAL FIX: MODAL LAYOUT --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: 1000;
            display: none; justify-content: center; align-items: center;
        }
        .modal-overlay.show { display: flex; }

        .modal-container {
            background: #fff;
            width: 900px;
            max-width: 95%;
            height: 85vh; /* Fixed height relative to viewport */
            max-height: 600px; /* Cap max height */
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex;       /* FLEX COLUMN IS KEY */
            flex-direction: column; 
            overflow: hidden;    /* Prevents container scrolling */
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0; /* Header never shrinks */
        }

        .modal-body {
            display: flex;
            flex: 1; /* Takes all available space between header and footer */
            overflow: hidden; /* Internal elements scroll, not body */
            min-height: 0; /* Required for Firefox flex scrolling */
        }

        .modal-sidebar {
            width: 140px;
            background: #f9f9f9;
            border-right: 1px solid #eee;
            overflow-y: auto; /* Scrollable */
            flex-shrink: 0;
        }

        .modal-content {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto; /* Scrollable */
        }

        .modal-footer {
            padding: 15px 20px;
            background: #fff;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0; /* Footer never shrinks */
            z-index: 10;
        }

        /* --- Main Layout --- */
        .chat-window { flex: 1; overflow-y: auto; padding: 20px 40px; display: flex; flex-direction: column; min-width: 0; width: 100%; box-sizing: border-box; }
        #resultsArea { width: 100%; max-width: 100%; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="logo">
        <img src="{{ url_for('static', filename='iris_logo.png') }}" alt="IRIS Logo">
        <div class="logo-text">IRIS</div>
    </div>
    <div class="sidebar-tagline">Exact regulation.<br>Zero hallucination.</div>
    <div class="menu-label">Knowledge Base</div>
    <a href="/" class="nav-item"><i class="fas fa-search"></i> Universal Search</a>
    <a href="/health" class="nav-item"><i class="fas fa-heartbeat"></i> Health Dept</a>
    <a href="/life" class="nav-item"><i class="fas fa-umbrella"></i> Life Dept</a>
    <div class="menu-label">Data Intelligence</div>
    <a href="/data" class="nav-item active"><i class="fas fa-chart-line"></i> Data Explorer</a>
    <a href="/compliance" class="nav-item"><i class="fas fa-gavel"></i> Compliance Cockpit</a>
    <div class="menu-label">System</div>
    <a href="/analytics" class="nav-item"><i class="fas fa-server"></i> System Analytics</a>
    <a href="/admin" class="nav-item"><i class="fas fa-cog"></i> Admin Panel</a>
</div>

<div class="main-content">
    <div class="header-area">
        <div class="full-form-text">IRDAI's Regulatory Intelligence System</div>
        <div class="header-title-row">
            <i class="fas fa-chart-line module-icon"></i>
            <h2>Data Explorer</h2>
        </div>
        <p class="scope-indicator"><span class="scope-dot"></span> Scope: Financials & Market Data</p>
    </div>

    <div class="chat-window">
        <div class="filter-actions-bar">
            <button class="filter-btn-main" onclick="openFilterModal()">
                <i class="fas fa-sliders-h"></i> Filters & View
                <span class="filter-badge" id="filterCount" style="display:none;">0</span>
            </button>
            <span class="active-filters-text" id="activeFiltersText">No filters applied</span>
            <button class="reset-link" onclick="window.location.reload()">Reset Dashboard</button>
        </div>
        <div id="resultsArea">
            <div class="empty-state"><i class="fas fa-chart-bar"></i><p>Select <strong>Filters</strong> to generate a report.</p></div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="filterModal">
    <form id="filterForm" class="modal-container" onsubmit="applyFilters(event)">
        <div class="modal-header">
            <h3 style="margin:0;">Report Configuration</h3>
            <span class="close-modal" onclick="closeFilterModal()" style="cursor:pointer; font-size:20px;">&times;</span>
        </div>
        
        <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
            
            <div class="view-selector-container">
                <label class="view-selector-label">Step 1: Select Report View</label>
                <select name="dimension" id="dimensionSelect" class="view-selector-dropdown" onchange="updateEntityList()">
                    {% if options.dimensions and options.dimensions|length > 0 %}
                        {% for dim in options.dimensions %}
                            <option value="{{dim}}">{{dim}}-wise View</option>
                        {% endfor %}
                    {% else %}
                        <option value="Insurer" selected>Insurer-wise View</option>
                    {% endif %}
                </select>
            </div>

            <div class="modal-body">
                <div class="modal-sidebar">
                    <div class="category-item active" onclick="showCategory('entities', this)" id="entityTabLabel">Entities</div>
                    <div class="category-item" onclick="showCategory('metrics', this)">Metrics</div>
                    <div class="category-item" onclick="showCategory('classes', this)">Class of Biz</div>
                    <div class="category-item" onclick="showCategory('years', this)">Fin Year</div>
                    <div class="category-item" onclick="showCategory('quarters', this)">Quarter</div>
                    <div class="category-item" onclick="showCategory('lobs', this)">Line of Biz</div>
                </div>

                <div class="modal-content">
                    <input type="text" id="filterSearch" class="filter-search-box" placeholder="Search options..." onkeyup="filterCheckboxes()">

                    <div id="cat-entities" class="filter-options active">
                        <div class="quick-filter-chips" id="entityChips"></div>
                        <div id="entityCheckboxes">
                            <div style="padding:10px; color:#666;">Loading Entities...</div>
                        </div>
                    </div>

                    <div id="cat-metrics" class="filter-options">
                        {% if options.metrics %}
                            {% for m in options.metrics %}
                            <label class="checkbox-item"><input type="checkbox" name="metrics" value="{{m}}"><span>{{m}}</span></label>
                            {% endfor %}
                        {% else %} <div class="no-data-msg">No Metrics found.</div> {% endif %}
                    </div>

                    <div id="cat-classes" class="filter-options">
                        {% if options.classes %}
                            {% for c in options.classes %}
                            <label class="checkbox-item"><input type="checkbox" name="classes" value="{{c}}"><span>{{c}}</span></label>
                            {% endfor %}
                        {% else %} <div class="no-data-msg">No Classes found.</div> {% endif %}
                    </div>

                    <div id="cat-years" class="filter-options">
                        {% if options.years %}
                            {% for y in options.years %}
                            <label class="checkbox-item"><input type="checkbox" name="years" value="{{y}}"><span>{{y}}</span></label>
                            {% endfor %}
                        {% else %} <div class="no-data-msg">No Data.</div> {% endif %}
                    </div>

                    <div id="cat-quarters" class="filter-options">
                        {% if options.quarters %}
                            {% for q in options.quarters %}
                            <label class="checkbox-item"><input type="checkbox" name="quarters" value="{{q}}"><span>{{q}}</span></label>
                            {% endfor %}
                        {% else %} <div class="no-data-msg">No Data.</div> {% endif %}
                    </div>

                    <div id="cat-lobs" class="filter-options">
                        {% if options.lobs %}
                            {% for l in options.lobs %}
                            <label class="checkbox-item"><input type="checkbox" name="lobs" value="{{l}}"><span>{{l}}</span></label>
                            {% endfor %}
                        {% else %} <div class="no-data-msg">No Data.</div> {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn-text" onclick="clearModalInputs()">
                <i class="fas fa-trash-alt"></i> Clear All
            </button>
            <button type="submit" class="btn-primary">
                <i class="fas fa-check"></i> Apply Filters
            </button>
        </div>
    </form>
</div>

<script>
    const allEntities = {{ options.entities | tojson | default('{}') }};
    const defaultDim = "Insurer";

    function init() {
        console.log("IRIS Loaded. Entities Data:", allEntities); 
        updateEntityList();
    }

    function updateEntityList() {
        let dimSelect = document.getElementById('dimensionSelect');
        let dim = dimSelect.value || defaultDim;

        const container = document.getElementById('entityCheckboxes');
        const chipsContainer = document.getElementById('entityChips');
        const tabLabel = document.getElementById('entityTabLabel');

        tabLabel.innerText = (dim === 'Insurer') ? 'Insurers' : (dim + 's');
        container.innerHTML = "";
        chipsContainer.innerHTML = ""; 

        if (!allEntities || Object.keys(allEntities).length === 0) {
            container.innerHTML = '<div class="no-data-msg">⚠️ No entity data loaded.<br>Please go to Admin > Sync Data.</div>';
            return;
        }

        const list = allEntities[dim] || [];
        if (list.length === 0) {
            container.innerHTML = '<div class="no-data-msg">No data found for this view.</div>';
            return;
        }

        // --- CHIP GENERATION ---
        
        // 1. "All" Chip
        const allBtn = document.createElement("span");
        allBtn.className = "chip-btn";
        allBtn.innerText = "All " + dim + "s";
        allBtn.onclick = function() { selectAllEntities(true, this); };
        chipsContainer.appendChild(allBtn);

        // 2. Insurer Groups
        if (dim === 'Insurer') {
            const groups = [
                // Updated with Galaxy and Narayana
                {name: 'SAHIs', keys: ["Star", "Care", "Aditya Birla", "Niva", "Manipal", "Galaxy", "Narayana"]},
                {name: 'PSUs', keys: ["New India", "United India", "Oriental", "National"]},
                {name: 'Life', keys: ["LIC", "HDFC Life", "SBI Life", "ICICI Prudential"]}
            ];
            groups.forEach(g => {
                const btn = document.createElement("span");
                btn.className = "chip-btn";
                btn.innerText = g.name;
                btn.onclick = function() { selectGroup(g.keys, this); };
                chipsContainer.appendChild(btn);
            });
        }

        // 3. "Clear" Chip (Last)
        const clearBtn = document.createElement("span");
        clearBtn.className = "chip-btn";
        clearBtn.innerText = "Clear";
        clearBtn.style.color = "#d32f2f";
        clearBtn.style.borderColor = "#ffcdd2";
        clearBtn.onclick = function() { selectAllEntities(false, this); };
        chipsContainer.appendChild(clearBtn);

        // Populate Checkboxes
        list.forEach(ent => {
            const label = document.createElement('label');
            label.className = 'checkbox-item';
            label.innerHTML = `<input type="checkbox" name="entities" value="${ent}"><span>${ent}</span>`;
            container.appendChild(label);
        });
    }

    function selectAllEntities(check, btnElement) {
        document.querySelectorAll('#entityCheckboxes input').forEach(cb => cb.checked = check);
        highlightChip(btnElement);
        if(!check) removeHighlights(); 
    }

    function selectGroup(keywords, btnElement) {
        const inputs = document.querySelectorAll('#entityCheckboxes input');
        inputs.forEach(cb => cb.checked = false); 
        inputs.forEach(cb => {
            if (keywords.some(k => cb.value.toLowerCase().includes(k.toLowerCase()))) {
                cb.checked = true;
            }
        });
        highlightChip(btnElement);
    }

    function highlightChip(element) {
        document.querySelectorAll('.chip-btn').forEach(btn => btn.classList.remove('active'));
        if(element) element.classList.add('active');
    }

    function removeHighlights() {
        document.querySelectorAll('.chip-btn').forEach(btn => btn.classList.remove('active'));
    }

    function openFilterModal() { document.getElementById('filterModal').classList.add('show'); }
    function closeFilterModal() { document.getElementById('filterModal').classList.remove('show'); }

    function showCategory(catName, element) {
        document.querySelectorAll('.category-item').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        document.querySelectorAll('.filter-options').forEach(el => el.classList.remove('active'));
        document.getElementById('cat-' + catName).classList.add('active');
        document.getElementById('filterSearch').value = "";
        filterCheckboxes(); 
    }

    function filterCheckboxes() {
        const input = document.getElementById('filterSearch');
        const filter = input.value.toLowerCase();
        const activeTab = document.querySelector('.filter-options.active');
        const labels = activeTab.getElementsByTagName('label');
        for (let i = 0; i < labels.length; i++) {
            const span = labels[i].getElementsByTagName("span")[0];
            const txtValue = span.textContent || span.innerText;
            if (txtValue.toLowerCase().indexOf(filter) > -1) { labels[i].style.display = ""; } 
            else { labels[i].style.display = "none"; }
        }
    }

    function clearModalInputs() { 
        document.getElementById('filterForm').reset(); 
        updateEntityList(); 
    }

    function applyFilters(e) {
        e.preventDefault();
        const form = document.getElementById('filterForm');
        const formData = new FormData(form);
        
        if (formData.getAll('entities').length === 0 || formData.getAll('metrics').length === 0) {
            alert("⚠️ Please select at least one Entity and one Metric.");
            return;
        }

        closeFilterModal();
        let count = 0;
        let summary = [];
        const dim = formData.get('dimension') || defaultDim;
        summary.push(dim + " View");

        formData.getAll('entities').forEach(() => count++);
        formData.getAll('metrics').forEach(() => count++);
        
        const badge = document.getElementById('filterCount');
        if(count > 0) { badge.innerText = count; badge.style.display = 'inline-flex'; }
        else { badge.style.display = 'none'; }
        
        document.getElementById('activeFiltersText').innerText = "Report: " + summary.join(" + ");
        document.getElementById('resultsArea').innerHTML = '<div style="text-align:center; padding:40px; color:#666;"><div class="typing-indicator" style="display:inline-flex;"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div><br>Processing Data...</div>';

        fetch('/data', { method: 'POST', body: formData })
        .then(response => response.text())
        .then(html => { document.getElementById('resultsArea').innerHTML = html; });
    }

    function copyTableToClipboard() {
        const table = document.getElementById('exportTable');
        if (!table) { alert("No table to copy!"); return; }
        const range = document.createRange();
        range.selectNode(table);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        try { document.execCommand('copy'); alert("✅ Table copied!"); } 
        catch (err) { alert("❌ Failed to copy"); }
        window.getSelection().removeAllRanges();
    }

    function downloadExcel() {
        const form = document.getElementById('filterForm');
        form.action = "/download_data";
        form.method = "POST";
        form.target = "_blank";
        form.submit();
        setTimeout(() => { form.action = ""; form.target = ""; }, 100);
    }

    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>