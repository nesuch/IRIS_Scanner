<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IRIS - System Analytics</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .logo-text { margin-top: 8px; font-family: 'Montserrat', sans-serif; font-size: 30px; font-weight: 700; background: linear-gradient(180deg, #2b58a6 0%, #0a2357 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; color: transparent; letter-spacing: 1.5px; line-height: 1; text-transform: uppercase; padding-left: 1.5px; }
        
        .main-content { overflow-y: auto; height: 100vh; display: block; background: #f4f7f6; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; padding: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stat-val { font-size: 32px; font-weight: bold; color: #1a237e; }
        .stat-label { font-size: 14px; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        
        .charts-row { display: flex; padding: 0 20px; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .chart-wrapper { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); flex: 1; min-width: 300px; min-height: 300px; box-sizing: border-box; }
        
        .error-log { margin: 0 20px 20px 20px; background: #fff0f0; border: 1px solid #ffcccc; border-radius: 10px; padding: 0; overflow: hidden; }
        .log-header { padding: 15px 20px; border-bottom: 1px solid #ffcccc; color: #b71c1c; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        
        .clear-btn { background: #fff; border: 1px solid #d32f2f; color: #d32f2f; padding: 5px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; text-transform: uppercase; font-weight: bold; transition: 0.2s; }
        .clear-btn:hover { background: #d32f2f; color: white; }

        .table-scroll-container { width: 100%; overflow-x: auto; }
        .log-table { width: max-content; min-width: 100%; border-collapse: collapse; font-size: 13px; }
        .log-table th { text-align: left; padding: 10px 20px; border-bottom: 2px solid #ffcccc; color: #b71c1c; white-space: nowrap; background: #fff5f5; }
        .log-table td { padding: 8px 20px; border-bottom: 1px solid #ffebee; white-space: nowrap; color: #333; }
        
        .yearly-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .yearly-table th { text-align: left; padding: 10px; border-bottom: 2px solid #eee; color: #555; background: #fafafa; }
        .yearly-table td { padding: 10px; border-bottom: 1px solid #f0f0f0; color: #333; font-weight: 600; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="logo">
        <img src="{{ url_for('static', filename='iris_logo.png') }}" alt="IRIS Logo">
        <div class="logo-text">IRIS</div>
    </div>
    <div class="sidebar-tagline">Exact regulation.<br>Zero hallucination.</div>
    <div class="menu-label">Knowledge Base</div>
    <a href="/" class="nav-item"><i class="fas fa-search"></i> Universal Search</a>
    <a href="/health" class="nav-item"><i class="fas fa-heartbeat"></i> Health Dept</a>
    <a href="life" class="nav-item"><i class="fas fa-umbrella"></i> Life Dept</a>
    <div class="menu-label">Data Intelligence</div>
    <a href="/data" class="nav-item"><i class="fas fa-chart-line"></i> Data Explorer</a>
    <a href="/compliance" class="nav-item"><i class="fas fa-gavel"></i> Compliance Cockpit</a>
    <div class="menu-label">System</div>
    <a href="/analytics" class="nav-item active"><i class="fas fa-server"></i> System Analytics</a>
    <a href="/admin" class="nav-item"><i class="fas fa-cog"></i> Admin Panel</a>
</div>

<div class="main-content">
    <div class="header-area">
        <div class="full-form-text">System Health Monitoring</div>
        <div class="header-title-row">
            <i class="fas fa-satellite-dish module-icon"></i>
            <h2>IRIS Analytics</h2>
        </div>
        <p class="scope-indicator">Live Traffic & Error Tracking</p>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-val">{{ stats.users }}</div>
            <div class="stat-label">Unique Users</div>
        </div>
        <div class="stat-card">
            <div class="stat-val">{{ stats.total }}</div>
            <div class="stat-label">Total Requests</div>
        </div>
        <div class="stat-card" style="border-bottom: 4px solid {% if stats.errors > 0 %}#d32f2f{% else %}#2e7d32{% endif %};">
            <div class="stat-val" style="color: {% if stats.errors > 0 %}#d32f2f{% else %}#2e7d32{% endif %};">{{ stats.errors }}</div>
            <div class="stat-label">System Crashes</div>
        </div>
    </div>

    <div class="charts-row">
        <div class="chart-wrapper" style="flex: 2;">
            <h4 style="margin-top:0; color:#333;"><i class="fas fa-chart-line"></i> Monthly Traffic</h4>
            <div style="height: 250px; width: 100%;">
                <canvas id="monthlyChart"></canvas>
            </div>
        </div>
        
        <div class="chart-wrapper" style="flex: 1;">
            <h4 style="margin-top:0; color:#333;"><i class="fas fa-chart-pie"></i> Module Usage</h4>
            <div style="height: 250px; width: 100%;">
                <canvas id="trafficChart"></canvas>
            </div>
        </div>
    </div>

    <div style="margin: 0 20px 20px 20px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
        <h4 style="margin-top:0; color:#333; margin-bottom:15px;"><i class="fas fa-calendar-alt"></i> Yearly Overview</h4>
        <table class="yearly-table">
            <thead>
                <tr><th>Year</th><th>Total Interactions</th></tr>
            </thead>
            <tbody>
                {% if yearly %}
                    {% for year in yearly %}
                    <tr><td>{{ year.year }}</td><td>{{ year.count }}</td></tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="2" style="color:#999; font-weight:400; text-align:center;">No historical data available.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    {% if stats.errors > 0 %}
    <div class="error-log">
        <div class="log-header">
            <span><i class="fas fa-bug"></i> Recent Failures</span>
            <form action="clear_logs" method="POST" style="margin:0;">
                <button type="submit" class="clear-btn">Clear Crashes</button>
            </form>
        </div>
        <div class="table-scroll-container">
            <table class="log-table">
                <thead>
                    <tr><th>Time</th><th>Endpoint</th><th>Error Message</th></tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr>
                        <td>{{ log.timestamp }}</td>
                        <td>{{ log.endpoint }}</td>
                        <td style="white-space: normal; min-width: 400px;">{{ log.error }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div style="text-align:center; padding:30px; color:#aaa;">
        <i class="fas fa-check-circle" style="font-size:30px; margin-bottom:10px; color:#2e7d32;"></i><br>
        No system failures recorded.
    </div>
    {% endif %}
    
    <div style="height: 50px;"></div>
</div>

<script>
    // 2. REGISTER THE PLUGIN GLOBALLY
    Chart.register(ChartDataLabels);

    // ------------------------------------------
    // CHART 1: MODULE USAGE (DOUGHNUT)
    // ------------------------------------------
    const trafficData = {{ chart.data | tojson }};
    if (trafficData && trafficData.length > 0) {
        const ctx = document.getElementById('trafficChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: {{ chart.labels | tojson }},
                datasets: [{
                    data: trafficData,
                    backgroundColor: ['#3f51b5', '#2196f3', '#00bcd4', '#4caf50', '#ff9800'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } },
                    // --- PIE LABELS: Show Percentages ---
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 12 },
                        formatter: (value, ctx) => {
                            if(value === 0) return "";
                            let sum = 0;
                            let dataArr = ctx.chart.data.datasets[0].data;
                            dataArr.map(data => { sum += data; });
                            let percentage = (value*100 / sum).toFixed(0)+"%";
                            return percentage;
                        }
                    }
                }
            }
        });
    }

    // ------------------------------------------
    // CHART 2: MONTHLY TRAFFIC (LINE)
    // ------------------------------------------
    const monthlyData = {{ monthly.data | tojson }};
    if (monthlyData && monthlyData.length > 0) {
        const ctx2 = document.getElementById('monthlyChart').getContext('2d');
        new Chart(ctx2, {
            type: 'line',
            data: {
                labels: {{ monthly.labels | tojson }},
                datasets: [{
                    label: 'Requests',
                    data: monthlyData,
                    borderColor: '#1a237e',
                    backgroundColor: 'rgba(26, 35, 126, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 4,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#1a237e'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    // --- LINE LABELS: Show Counts on Top ---
                    datalabels: { 
                        display: true, 
                        align: 'top', 
                        color: '#1a237e', 
                        font: { weight: 'bold' },
                        formatter: (value) => value > 0 ? value : "" // Hide 0s for cleaner look
                    }
                },
                scales: {
                    // suggestedMax adds breathing room at the top for the labels
                    y: { beginAtZero: true, grid: { color: '#f0f0f0' }, suggestedMax: Math.max(...monthlyData) + 2 },
                    x: { grid: { display: false } }
                }
            }
        });
    }
</script>
</body>
</html>