<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IRIS Admin Panel</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* --- LOGO STYLES --- */
        .logo-text { 
            margin-top: 8px;
            font-family: 'Montserrat', sans-serif; 
            font-size: 30px; 
            font-weight: 700; 
            background: linear-gradient(180deg, #2b58a6 0%, #0a2357 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
            letter-spacing: 1.5px;
            line-height: 1;
            text-transform: uppercase;
            padding-left: 1.5px; 
        }

        /* --- PAGE SPECIFIC STYLES --- */
        .admin-container { 
            background: white; padding: 40px; border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; max-width: 600px; width: 100%; 
        }
        .sync-btn {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; border: none;
            padding: 15px 30px; border-radius: 8px; font-size: 16px; cursor: pointer; transition: 0.3s;
            display: inline-flex; align-items: center; justify-content: center; gap: 10px; width: 100%;
        }
        .sync-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(30, 60, 114, 0.3); }
        .sync-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .typing-indicator { display: flex; gap: 5px; justify-content: center; margin-bottom: 10px; }
        .dot { width: 8px; height: 8px; background: #0d47a1; border-radius: 50%; animation: blink 1.4s infinite; }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0% { opacity: .2; } 20% { opacity: 1; } 100% { opacity: .2; } }
    </style>
</head>
<body style="background-color: #f4f7f6; margin: 0;">

    <div class="sidebar">
        <div class="logo">
            <img src="{{ url_for('static', filename='iris_logo.png') }}" alt="IRIS Logo" style="height: 50px;">
            <div class="logo-text">IRIS</div>
        </div>
        <div class="sidebar-tagline">Exact regulation.<br>Zero hallucination.</div>
        
        <div class="menu-label">Knowledge Base</div>
        <a href="/" class="nav-item"><i class="fas fa-search"></i> Universal Search</a>
        <a href="/health" class="nav-item"><i class="fas fa-heartbeat"></i> Health Dept</a>
        <a href="/life" class="nav-item"><i class="fas fa-umbrella"></i> Life Dept</a>
        
        <div class="menu-label">Data Intelligence</div>
        <a href="/data" class="nav-item"><i class="fas fa-chart-line"></i> Data Explorer</a>
        <a href="/compliance" class="nav-item"><i class="fas fa-gavel"></i> Compliance Cockpit</a>
        
        <div class="menu-label">System</div>
        <a href="/analytics" class="nav-item"><i class="fas fa-server"></i> System Analytics</a>
        <a href="/admin" class="nav-item active"><i class="fas fa-cog"></i> Admin Panel</a>
    </div>

    <div class="main-content" style="display:flex; justify-content:center; align-items:center; height:100vh; margin-left: 260px;">
        <div class="admin-container">
            <h1 style="color:#333; margin-bottom:10px; font-size:24px;">Knowledge Base Sync</h1>
            <p style="color:#666; margin-bottom:30px; line-height:1.5;">
                <strong>Step 1:</strong> Place Excel files into: <br>
                <code style="background:#eee; padding:2px 6px; border-radius:4px;">knowledge_base/raw_submissions/</code>
                <br><br>
                <strong>Step 2:</strong> Click below. The system will process files in the background.
            </p>
            
            <button id="syncBtn" onclick="startSync()" class="sync-btn">
                <i class="fas fa-sync-alt"></i> Start Aggregate & Sync
            </button>

            <div id="statusArea" style="margin-top:25px; padding:15px; border-radius:6px; display:none;">
                <div id="loadingSpinner" class="typing-indicator" style="display:none;">
                    <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                </div>
                <div id="statusText" style="font-weight:bold; text-align:center;"></div>
            </div>
        </div>
    </div>

    <script>
        function startSync() {
            const btn = document.getElementById('syncBtn');
            const statusArea = document.getElementById('statusArea');
            const statusText = document.getElementById('statusText');
            const spinner = document.getElementById('loadingSpinner');

            // 1. Disable Button & Show Loading UI
            btn.disabled = true;
            btn.style.opacity = "0.6";
            statusArea.style.display = "block";
            statusArea.style.background = "#e3f2fd"; // Light Blue
            statusArea.style.color = "#0d47a1"; // Dark Blue
            statusArea.style.border = "1px solid #bbdefb";
            spinner.style.display = "flex";
            statusText.innerText = "Initializing Sync Process...";

            // 2. Send Start Command
            fetch('/sync_data', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'started') {
                    // 3. Start Polling for Updates
                    pollStatus();
                } else if(data.status === 'busy') {
                    statusText.innerText = "System is busy. Sync already running.";
                    spinner.style.display = "none";
                } else {
                    statusText.innerText = data.message;
                    btn.disabled = false;
                    spinner.style.display = "none";
                }
            })
            .catch(err => {
                statusText.innerText = "Server Error: Could not start sync.";
                btn.disabled = false;
                spinner.style.display = "none";
            });
        }

        function pollStatus() {
            const timer = setInterval(() => {
                fetch('/check_sync_status')
                .then(res => res.json())
                .then(data => {
                    document.getElementById('statusText').innerText = data.message;

                    if (data.state === 'COMPLETED') {
                        clearInterval(timer);
                        finishSync(true, data.message);
                    } else if (data.state === 'ERROR') {
                        clearInterval(timer);
                        finishSync(false, data.message);
                    }
                    // If 'RUNNING', do nothing and keep polling
                })
                .catch(err => {
                    // Stop polling on network error
                    clearInterval(timer);
                    finishSync(false, "Network Error: Connection lost.");
                });
            }, 1000); // Check every 1 second
        }

        function finishSync(success, msg) {
            const statusArea = document.getElementById('statusArea');
            const spinner = document.getElementById('loadingSpinner');
            const btn = document.getElementById('syncBtn');
            const statusText = document.getElementById('statusText');

            spinner.style.display = "none";
            btn.disabled = false;
            btn.style.opacity = "1";
            statusText.innerText = msg;

            if (success) {
                statusArea.style.background = "#e8f5e9"; // Light Green
                statusArea.style.color = "#2e7d32"; // Dark Green
                statusArea.style.border = "1px solid #c8e6c9";
            } else {
                statusArea.style.background = "#ffebee"; // Light Red
                statusArea.style.color = "#c62828"; // Dark Red
                statusArea.style.border = "1px solid #ffcdd2";
            }
        }
    </script>
</body>
</html>